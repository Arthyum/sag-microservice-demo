version: "3.0"

networks:
  sagdemodev:

services:
  compile:
    image: ${CUSTOM_REGISTRY}softwareag/abe:10.1
    command: ant -DprojectName=${PROJECT_NAME} build
    environment:
      - EXIT_AFTER_COMMAND=true
    volumes:
      - ${WORKSPACE-.}:/workspace
    networks:
      - sagdemodev

  deploy:
    image: ${CUSTOM_REGISTRY}softwareag/deployer:10.1
    command: ant -DprojectName=${PROJECT_NAME} deploy
    environment:
      - EXIT_AFTER_COMMAND=false
    volumes:
      - ${WORKSPACE-.}:/workspace
    ports:
      - "8094:5555"
      - "8095:9999"
    networks:
      - sagdemodev

  unittests:
    image: ${CUSTOM_REGISTRY}softwareag/wmtestsuite:10.1
    command: ant -DprojectName=${PROJECT_NAME} test
    environment:
      - EXIT_AFTER_COMMAND=false
    volumes:
      - ${WORKSPACE-.}:/workspace
    networks:
      - sagdemodev

  mscdev:
    image: store/softwareag/webmethods-microservicesruntime:${TAG}
    networks:
      - sagdemodev
    volumes: 
      - ./replicate:${SAG_HOME}/IntegrationServer/instances/default/replicate
      - ./msc_consul_config_registry.cnf:${SAG_HOME}/IntegrationServer/instances/default/config/microservices/registry.cnf
    ports:
      - "5555:5555"
    depends_on:
      - consul-server-bootstrap
      - consul-server-1
      - consul-server-2
      - consul-agent-1
      - consul-agent-2
      - consul-agent-3

  consul-agent-1: &consul-agent
    image: consul:1.2.3
    networks:
      - sagdemodev
    command: "agent -retry-join consul-server-bootstrap -client 0.0.0.0"

  consul-agent-2:
    <<: *consul-agent

  consul-agent-3:
    <<: *consul-agent

  consul-server-1: &consul-server
    <<: *consul-agent
    command: "agent -server -retry-join consul-server-bootstrap -client 0.0.0.0"

  consul-server-2:
    <<: *consul-server

  consul-server-bootstrap:
    <<: *consul-agent
    ports:
      - "8400:8400"
      - "8500:8500"
      - "8600:8600"
    command: "agent -server -bootstrap-expect 3 -ui -client 0.0.0.0"